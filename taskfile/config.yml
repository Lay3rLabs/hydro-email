version: "3"

vars:
  # Paths
  PATH_REPO_ROOT:
    sh: git rev-parse --show-toplevel
  PATH_BUILDS: '{{joinPath .PATH_REPO_ROOT ".builds"}}'
  PATH_WIT_DEFINITIONS: '{{joinPath .PATH_REPO_ROOT "wit-definitions"}}'
  PATH_TEMP_CLONE: '{{joinPath .PATH_REPO_ROOT ".temp-clone"}}'
  PATH_COMPONENT_BUILDS: '{{joinPath .PATH_BUILDS "components"}}'
  PATH_CONTRACT_BUILDS: '{{joinPath .PATH_BUILDS "contracts"}}'
  PATH_CONTRACT_SCHEMA: '{{joinPath .PATH_BUILDS "contract-schemas"}}'
  PATH_DEPLOYMENTS: '{{joinPath .PATH_REPO_ROOT ".deployments"}}'
  PATH_BACKEND: '{{joinPath .PATH_REPO_ROOT "backend"}}'
  PATH_WAVS_HOME: '{{joinPath .PATH_BACKEND "wavs-home"}}'
  PATH_DOCKER_FILES: '{{joinPath .PATH_BACKEND "docker"}}'
  PATH_CHAINS: '{{joinPath .PATH_BACKEND "chains"}}'

  # Components
  COMPONENT_WAVS_WIT_BRANCH: "main"
  ALL_OPERATOR_COMPONENTS: ["email-reader"]
  ALL_AGGREGATOR_COMPONENTS: ["submitter"]
  COMPONENT_PREFIX: "app-component"

  # Contracts
  ALL_CONTRACTS: ["service-handler", "proxy"]
  CONTRACT_PREFIX: "app-contract"
  CW_OPTIMIZER_CACHE: "hydro-email"

  # OAUTH config
  OAUTH_AUTH_URL: https://accounts.google.com/o/oauth2/v2/auth
  OAUTH_TOKEN_URL: https://oauth2.googleapis.com/token
  OAUTH_GMAIL_SCOPE: "https://www.googleapis.com/auth/gmail.modify"

  # Service config
  SERVICE_CRON_SCHEDULE: "*/10 * * * * * *" # Every 10 seconds

  # Docker images
  DOCKER_IMAGE_WAVS: 'ghcr.io/lay3rlabs/wavs:2.0.0-rc.8{{if eq .ARCH "arm64"}}-arm64{{end}}'
  DOCKER_IMAGE_WAVS_CW_MIDDLEWARE: 'ghcr.io/lay3rlabs/cw-middleware:0.2.0-alpha.12{{if eq .ARCH "arm64"}}-arm64{{end}}'
  DOCKER_IMAGE_COSMWASM_OPTIMIZER: 'cosmwasm/optimizer{{if eq .ARCH "arm64"}}-arm64{{end}}:0.17.0'
  DOCKER_IMAGE_JAEGER: "jaegertracing/jaeger:2.5.0"
  DOCKER_IMAGE_PROMETHEUS: "prom/prometheus:v3.3.0"
  DOCKER_IMAGE_IPFS: "ipfs/kubo:v0.38.1"
  DOCKER_IMAGE_GREENMAIL: "greenmail/standalone:latest"

  # Ports
  LOCAL_PORT_WAVS_OPERATOR_BASE: 8123 # Base port for WAVS, subsequent ports will be incremented by 1 for each instance
  LOCAL_PORT_WAVS_AGGREGATOR: 8200
  LOCAL_PORT_IPFS_API: 8300
  LOCAL_PORT_IPFS_GATEWAY: 8301
  LOCAL_PORT_JAEGER_UI: 16686
  LOCAL_PORT_PROMETHEUS_UI: 9092

  # Deployment
  TESTNET_CHAIN_KEY: "cosmos:pion-1"
  MAINNET_CHAIN_KEY: "cosmos:neutron-1"
  LOCAL_CHAIN_KEY: "dev:local"

  # neither env vars nor any dynamic vars are available at this stage, so we have to read .env manually
  DEPLOY_CHAIN_TARGET:
    sh: grep '^DEPLOY_CHAIN_TARGET=' "$(git rev-parse --show-toplevel)/.env" | cut -d'=' -f2 | cut -d'#' -f1 | tr -d ' '
  DEPLOY_WAVS_TARGET:
    sh: grep '^DEPLOY_WAVS_TARGET=' "$(git rev-parse --show-toplevel)/.env" | cut -d'=' -f2 | cut -d'#' -f1 | tr -d ' '
  DEPLOY_IPFS_TARGET:
    sh: grep '^DEPLOY_IPFS_TARGET=' "$(git rev-parse --show-toplevel)/.env" | cut -d'=' -f2 | cut -d'#' -f1 | tr -d ' '

  CHAIN_KEY:
    sh: |
      if [ "{{.DEPLOY_CHAIN_TARGET}}" = "local" ]; then
        echo "{{.LOCAL_CHAIN_KEY}}"
      elif [ "{{.DEPLOY_CHAIN_TARGET}}" = "testnet" ]; then
        echo "{{.TESTNET_CHAIN_KEY}}"
      elif [ "{{.DEPLOY_CHAIN_TARGET}}" = "mainnet" ]; then
        echo "{{.MAINNET_CHAIN_KEY}}"
      else
        echo "Error: Invalid DEPLOY_CHAIN_TARGET '{{.DEPLOY_CHAIN_TARGET}}'. Must be one of: local, testnet, mainnet" >&2
        exit 1
      fi

  IPFS_KIND:
    sh: |
      if [ "{{.DEPLOY_IPFS_TARGET}}" = "local" ]; then
        echo "kubo"
      elif [ "{{.DEPLOY_IPFS_TARGET}}" = "remote" ]; then
        echo "{{.REMOTE_IPFS_KIND}}"
      else
        echo "Error: Invalid DEPLOY_IPFS_TARGET '{{.DEPLOY_IPFS_TARGET}}'. Must be one of: local, remote" >&2
        exit 1
      fi

  IPFS_API_URL:
    sh: |
      if [ "{{.DEPLOY_IPFS_TARGET}}" = "local" ]; then
        echo "http://127.0.0.1:{{.LOCAL_PORT_IPFS_API}}"
      elif [ "{{.DEPLOY_IPFS_TARGET}}" = "remote" ]; then
        echo "{{.REMOTE_IPFS_API_URL}}"
      else
        echo "Error: Invalid DEPLOY_IPFS_TARGET '{{.DEPLOY_IPFS_TARGET}}'. Must be one of: local, remote" >&2
        exit 1
      fi

  IPFS_GATEWAY_URL:
    sh: |
      if [ "{{.DEPLOY_IPFS_TARGET}}" = "local" ]; then
        echo "http://127.0.0.1:{{.LOCAL_PORT_IPFS_GATEWAY}}"
      elif [ "{{.DEPLOY_IPFS_TARGET}}" = "remote" ]; then
        echo "{{.REMOTE_IPFS_GATEWAY_URL}}"
      else
        echo "Error: Invalid DEPLOY_IPFS_TARGET '{{.DEPLOY_IPFS_TARGET}}'. Must be one of: local, remote" >&2
        exit 1
      fi

  WAVS_AGGREGATOR_URL:
    sh: |
      if [ "{{.DEPLOY_WAVS_TARGET}}" = "local" ]; then
        echo "http://127.0.0.1:{{.LOCAL_PORT_WAVS_AGGREGATOR}}"
      elif [ "{{.DEPLOY_WAVS_TARGET}}" = "remote" ]; then
        echo "{{.REMOTE_WAVS_AGGREGATOR_URL}}"
      else
        echo "Error: Invalid DEPLOY_WAVS_TARGET '{{.DEPLOY_WAVS_TARGET}}'. Must be one of: local, remote" >&2
        exit 1
      fi

  ALL_MNEMONICS_TO_FUND:
    [
      "CLI_MNEMONIC",
      "WAVS_OPERATOR_MNEMONIC_1",
      "WAVS_OPERATOR_MNEMONIC_2",
      "WAVS_AGGREGATOR_COSMOS_CREDENTIAL",
    ]
  COMPONENT_WITS_OPERATOR_COMMANDER: ["wavs:operator@2.0.0"]

  # Middleware
  DEFAULT_MIDDLEWARE_SIGNER_WEIGHT: 100

  # Timeouts
  TIMEOUT_HEALTH_CHECK: 30 # seconds to wait for service health checks

  # Deployment
  DEPLOY_FILENAME_MIDDLEWARE_SERVICE_MANAGER_CODE_ID: "middleware-service-manager-code-id.json"
  DEPLOY_FILENAME_MIDDLEWARE_STAKE_REGISTRY_CODE_ID: "middleware-stake-registry-code-id.json"
  DEPLOY_FILENAME_MIDDLEWARE_INSTANTIATE: "middleware-instantiate.json"
  DEPLOY_FILENAME_MIDDLEWARE_SIGNING_KEY: "middleware-signing-key.json"
  DEPLOY_FILENAME_CONTRACT_SERVICE_HANDLER_CODE_ID: "contract-service-handler-code-id.json"
  DEPLOY_FILENAME_CONTRACT_SERVICE_HANDLER_INSTANTIATE: "contract-service-handler-instantiate.json"
  DEPLOY_FILENAME_CONTRACT_PROXY_CODE_ID: "contract-proxy-code-id.json"
  DEPLOY_FILENAME_CONTRACT_PROXY_INSTANTIATE: "contract-proxy-instantiate.json"
  DEPLOY_FILENAME_COMPONENT_OPERATOR_EMAIL_READER_CID: "component-operator-email-reader-cid.json"
  DEPLOY_FILENAME_COMPONENT_AGGREGATOR_SUBMITTER_CID: "component-aggregator-submitter-cid.json"
  DEPLOY_FILENAME_SERVICE_CID: "service-cid.json"
  DEPLOY_PROXY_SALT: "0x676f6f64207669626573203c33" # this will be hashed with the code-id to produce the address, so re-deploys won't conflict

  # Misc
  DOCKER_SUDO:
    sh: |
      if command -v docker >/dev/null 2>&1 && docker info >/dev/null 2>&1; then
        echo ""
      else
        echo "sudo"
      fi
  # TASK_HELPER_DEV_MODE: "true" # if set, uses `cargo run` instead of the built task-helper binary
