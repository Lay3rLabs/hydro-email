version: "3"

includes:
  config:
    taskfile: ./config.yml
    flatten: true

tasks:
  gmail-bootstrap:
    desc: "Bootstrap Gmail OAuth (local server displays auth code)"
    cmds:
      - |
        set -euo pipefail
        : "${WAVS_ENV_GMAIL_CLIENT_ID:?Set WAVS_ENV_GMAIL_CLIENT_ID to your OAuth Client ID}"
        : "${WAVS_ENV_GMAIL_CLIENT_SECRET:?Set WAVS_ENV_GMAIL_CLIENT_SECRET to your OAuth Client Secret}"

        # Check for required tools
        if ! command -v jq >/dev/null 2>&1; then
          echo "Error: jq is required. Install it with: brew install jq (macOS) or apt install jq (Linux)"
          exit 1
        fi

        if ! command -v http-server >/dev/null 2>&1; then
          echo "Error: http-server is required. See README.md"
          exit 1
        fi

        # Generate PKCE verifier/challenge for security
        if command -v openssl >/dev/null 2>&1; then
          VERIFIER_RAW="$(openssl rand -base64 64)"
          CODE_CHALLENGE="$(printf '%s' "$VERIFIER_RAW" | tr -d '\n\r' | tr '+/' '-_' | tr -d '=' \
            | openssl dgst -binary -sha256 | base64 | tr '+/' '-_' | tr -d '=')"
          CODE_VERIFIER="$(printf '%s' "$VERIFIER_RAW" | tr -d '\n\r' | tr '+/' '-_' | tr -d '=')"
        else
          echo "Error: openssl is required for PKCE generation"
          exit 1
        fi

        # URL encode function
        urlencode() {
          python3 -c "import sys, urllib.parse; print(urllib.parse.quote(sys.argv[1], safe=''))" "$1"
        }

        # Start local HTTP server in background
        # Find a free port starting at 53682
        if [ -n "${OAUTH_PORT:-}" ]; then
          PORT="$OAUTH_PORT"
        else
          PORT=53682
          MAX_PORT=53782  # Try 100 ports
          while [ $PORT -le $MAX_PORT ]; do
            if ! lsof -Pi :$PORT -sTCP:LISTEN -t >/dev/null 2>&1; then
              break
            fi
            PORT=$((PORT + 1))
          done
          if [ $PORT -gt $MAX_PORT ]; then
            echo "Error: Could not find free port in range 53682-53782"
            echo "Try manually setting OAUTH_PORT to a free port in your .env"
            exit 1
          fi
        fi

        REDIRECT_URI="http://localhost:${PORT}/index.html"

        echo "Starting local HTTP server on port ${PORT}..."

        # Temporarily disable -u to capture background PID safely
        set +u
        cd backend/oauth-site && http-server -p ${PORT} . > /tmp/http-server.log 2>&1 &
        SERVER_PID=$!
        set -u

        # Give server time to start and verify it's working
        sleep 2

        # Check if server is responding (better than checking process)
        if ! curl -s http://localhost:${PORT}/index.html > /dev/null 2>&1; then
          # Double check process is running
          if ! kill -0 $SERVER_PID 2>/dev/null; then
            echo "Error: HTTP server process died"
            echo "Try manually setting OAUTH_PORT to a free port in your .env"
            exit 1
          fi
          # Server running but not ready yet, wait a bit more
          sleep 1
        fi

        # Ensure server is killed on exit
        trap "kill $SERVER_PID 2>/dev/null || true" EXIT

        # Build authorization URL
        CLIENT_ID_ENC=$(urlencode "$WAVS_ENV_GMAIL_CLIENT_ID")
        REDIRECT_URI_ENC=$(urlencode "$REDIRECT_URI")
        SCOPE_ENC=$(urlencode "{{.OAUTH_GMAIL_SCOPE}}")

        AUTH_URL="{{.OAUTH_AUTH_URL}}?response_type=code&client_id=${CLIENT_ID_ENC}&redirect_uri=${REDIRECT_URI_ENC}&scope=${SCOPE_ENC}&access_type=offline&prompt=consent&code_challenge=${CODE_CHALLENGE}&code_challenge_method=S256"

        # Display instructions
        echo
        echo "=========================================="
        echo "  GOOGLE AUTHORIZATION REQUIRED"
        echo "=========================================="
        echo
        echo "1. Open this URL in your browser:"
        echo
        echo "$AUTH_URL"
        echo
        echo "2. After approving, you'll see a page with"
        echo "   your authorization code displayed."
        echo
        echo "3. Copy the code from that page and paste"
        echo "   it below."
        echo
        echo "=========================================="
        echo

        # Prompt for code
        read -r -p "Paste the authorization code here: " AUTH_CODE

        # Stop the server
        kill $SERVER_PID 2>/dev/null || true
        echo
        echo "Server stopped."

        if [ -z "$AUTH_CODE" ]; then
          echo "Error: No code provided"
          exit 1
        fi

        echo
        echo "Exchanging code for tokens..."

        # Exchange code for tokens
        TOK="$(curl -sS -X POST "{{.OAUTH_TOKEN_URL}}" \
          -H "Content-Type: application/x-www-form-urlencoded" \
          --data-urlencode "grant_type=authorization_code" \
          --data-urlencode "code=${AUTH_CODE}" \
          --data-urlencode "redirect_uri=${REDIRECT_URI}" \
          --data-urlencode "client_id=${WAVS_ENV_GMAIL_CLIENT_ID}" \
          --data-urlencode "client_secret=${WAVS_ENV_GMAIL_CLIENT_SECRET}" \
          --data-urlencode "code_verifier=${CODE_VERIFIER}")" || {
          echo "Error: Token request failed"
          exit 2
        }

        # Parse response
        ERROR="$(echo "$TOK" | jq -r '.error // empty')"
        if [ -n "$ERROR" ]; then
          echo "Error from Google: $ERROR"
          echo "$TOK" | jq -r '.error_description // empty'
          exit 3
        fi

        REFRESH="$(echo "$TOK" | jq -r '.refresh_token // empty')"
        ACCESS_TOKEN="$(echo "$TOK" | jq -r '.access_token // empty')"
        EXPIRES="$(echo "$TOK" | jq -r '.expires_in // empty')"

        if [ -z "$REFRESH" ]; then
          echo "Error: No refresh_token returned."
          echo
          echo "Tips:"
          echo "- Make sure you included access_type=offline and prompt=consent"
          echo "- If you previously authorized this app, revoke it at:"
          echo "  https://myaccount.google.com/permissions"
          echo
          echo "Full response:"
          echo "$TOK"
          exit 4
        fi

        # Display success message
        echo
        echo "=========================================="
        echo "  SUCCESS!"
        echo "=========================================="
        echo
        echo "Add this to your .env file:"
        echo
        echo "WAVS_ENV_GMAIL_TOKEN=${REFRESH}"
        echo
        echo "=========================================="
        echo
        echo "You can close your browser window now :)"
